services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    
    container_name: fastapi-api
    
    # Map port 8000 on your machine to port 8000 in container
    ports:
      - "8000:8000"
    
    # Environment variables for the app
    environment:
      # PostgreSQL connection (matches 'db' service below)
      - DATABASE_URL=postgres://postgres:postgres@db:5432/social_app
      # Redis connection (matches 'redis' service below)
      - REDIS_URL=redis://redis:6379/0
      # App settings
      - SECRET_KEY=dev-secret-key-change-in-production
      - DEBUG=true
    
    # Wait for database and redis to be ready before starting
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    
    volumes:
      - .:/app
    
    # Override the Dockerfile CMD for development
    # --reload watches for file changes and restarts the server
    command: uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload
    
    # Restart if it crashes
    restart: unless-stopped

  # PostgreSQL Database
  db:
    # Use PostgreSQL 15 with Alpine Linux
    image: postgres:15-alpine
    
    container_name: fastapi-db
    
    # Database configuration
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: social_app
    
    volumes:
      - postgres_data:/var/lib/postgresql/data
    
    # Expose PostgreSQL port
    ports:
      - "5432:5432"
    
    # Health check - docker compose waits until this passes
    # before starting the 'api' service
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    
    restart: unless-stopped

  # Redis Cache
  redis:
    # Redis 7 with Alpine Linux
    image: redis:7-alpine
    
    container_name: fastapi-redis
    
    # Expose Redis port
    ports:
      - "6379:6379"
    
    # Persist Redis data
    volumes:
      - redis_data:/data
    
    # Enable persistence so data survives restarts
    command: redis-server --appendonly yes
    
    restart: unless-stopped

  pgadmin:
    image: dpage/pgadmin4:latest
    
    container_name: fastapi-pgadmin
    
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    
    ports:
      - "5050:80"
    
    depends_on:
      - db
    
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data: